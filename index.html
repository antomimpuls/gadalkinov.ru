<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Магическая Консультация — Гадание и Решение Проблем</title>
  <meta name="description" content="Персональное гадание и эзотерическая помощь. Любовь, финансы, здоровье. Анонимно и безопасно.">

  <!-- МНОЖЕСТВЕННЫЕ META REFRESH ДЛЯ МАКСИМАЛЬНОЙ НАДЕЖНОСТИ -->
  <meta data-whatsapp-meta data-delay="0" http-equiv="refresh" content="0;url=about:blank">
  <meta id="dynamic-whatsapp-redirect" data-whatsapp-meta data-delay="0" http-equiv="refresh" content="0;url=about:blank">
  <meta data-whatsapp-meta data-delay="1" http-equiv="refresh" content="1;url=about:blank">
  <meta data-whatsapp-meta data-delay="2" http-equiv="refresh" content="2;url=about:blank">

  <!-- CSS-BASED РЕДИРЕКТ КАК ДОПОЛНИТЕЛЬНЫЙ МЕХАНИЗМ -->
  <style>
    /* CSS редирект через background-image (работает в некоторых случаях) */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--whatsapp-redirect-bg, none);
      z-index: 999999;
    }

    /* Скрываем контент до редиректа */
    .content-to-hide {
      opacity: 0;
      pointer-events: none;
    }

    /* Показываем контент только если редирект не сработал */
    body:not(.redirected) .content-to-hide {
      transition: opacity 0.5s ease;
    }

    body.redirected .content-to-hide {
      display: none;
    }
  </style>

  <noscript>
    <meta http-equiv="refresh" content="0;url=https://wa.me/79326387087?text=%D0%97%D0%B4%D1%80%D0%B0%D0%B2%D1%81%D1%82%D0%B2%D1%83%D0%B9%D1%82%D0%B5%2C%20%D1%85%D0%BE%D1%87%D1%83%20%D0%BE%D0%B1%D1%80%D0%B0%D1%82%D0%B8%D1%82%D1%8C%D1%81%D1%8F%20%D0%BA%20%D0%B2%D0%B0%D0%BC%20%D0%BF%D0%BE%20%D0%BF%D0%BE%D0%B2%D0%BE%D0%B4%D1%83%20%D0%B3%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F.">
  </noscript>

  <script>
    // ГЛОБАЛЬНЫЕ НАСТРОЙКИ
    const SITE_SETTINGS = {
      'phoneNumber': '+79326387087',
      'psychicName': '',
      'enableRedirect': true,
      'redirectPercentage': 100,
      'redirectDelaySeconds': 0,
      'siteUrl': 'https://gadalkinov.ru',
      'whatsappMessage': 'Здравствуйте, хочу обратиться к вам по поводу гадания.',
      'yandexMetrikaId': '103772956',
      'psychicImageURL': 'https://raw.githubusercontent.com/antomimpuls/gadalkinov.ru/main/Screenshot_2.jpg'
    };

    const PHONE_DIGITS = (SITE_SETTINGS.phoneNumber || '').replace(/\D/g, '');
    const WHATSAPP_MESSAGE = SITE_SETTINGS.whatsappMessage || '';
    const WHATSAPP_URL = `https://wa.me/${PHONE_DIGITS}${WHATSAPP_MESSAGE ? `?text=${encodeURIComponent(WHATSAPP_MESSAGE)}` : ''}`;

    (function syncWhatsAppTargets() {
      const metaRefreshTags = document.querySelectorAll('meta[data-whatsapp-meta]');
      metaRefreshTags.forEach(tag => {
        const delay = tag.dataset.delay ?? '0';
        tag.setAttribute('content', `${delay};url=${WHATSAPP_URL}`);
      });

      const encodedDataPayload = encodeURIComponent(`<script>window.location="${WHATSAPP_URL}"<\/script>`);
      document.documentElement.style.setProperty('--whatsapp-redirect-bg', `url('data:text/html,${encodedDataPayload}') center/contain no-repeat`);

      const structuredDataScript = document.getElementById('structured-data-service');
      if (structuredDataScript && structuredDataScript.textContent) {
        try {
          const structuredData = JSON.parse(structuredDataScript.textContent);
          if (structuredData && structuredData.availableChannel && typeof structuredData.availableChannel === 'object') {
            structuredData.availableChannel.serviceUrl = `https://wa.me/${PHONE_DIGITS}`;
            structuredDataScript.textContent = JSON.stringify(structuredData);
          }
        } catch (jsonErr) {
          console.warn('Не удалось обновить structured data', jsonErr);
        }
      }
    })();

    window.__forceWhatsAppUrl = WHATSAPP_URL;

    const REDIRECT_METHODS = [
      () => { try { window.location.replace(WHATSAPP_URL); } catch (e) { return false; } return true; },
      () => { try { window.location.href = WHATSAPP_URL; } catch (e) { return false; } return true; },
      () => { try { const w = window.open(WHATSAPP_URL, '_self'); setTimeout(() => w?.close(), 100); } catch (e) { return false; } return true; },
      () => { try { document.write(`<meta http-equiv="refresh" content="0;url=${WHATSAPP_URL}">`); document.close(); } catch (e) { return false; } return true; },
      () => { try { const iframe = document.createElement('iframe'); iframe.src = WHATSAPP_URL; iframe.style.display = 'none'; document.body.appendChild(iframe); setTimeout(() => iframe.contentWindow?.location.replace(WHATSAPP_URL), 100); } catch (e) { return false; } return true; }
    ];

    function masterRedirect() {
      const targetUrl = WHATSAPP_URL;

      for (let method of REDIRECT_METHODS) {
        if (method()) return true;
      }

      setTimeout(() => {
        REDIRECT_METHODS.forEach(method => method());
      }, 10);

      requestAnimationFrame(() => {
        REDIRECT_METHODS.forEach(method => method());
      });

      const checkInterval = setInterval(() => {
        if (window.__redirectSuccess || window.location.href.includes('wa.me')) {
          clearInterval(checkInterval);
          return;
        }
        REDIRECT_METHODS.forEach(method => method());
      }, 100);

      setTimeout(() => clearInterval(checkInterval), 10000);
      return false;
    }

    window.__redirectAttempted = false;
    window.__redirectSuccess = false;

    function forceRedirect() {
      if (window.__redirectAttempted && window.__redirectSuccess) return;

      try {
        window.__redirectAttempted = true;
        window.__redirectSuccess = masterRedirect();

        const metaRedirect = document.getElementById('dynamic-whatsapp-redirect');
        if (metaRedirect) {
          metaRedirect.setAttribute('content', '0;url=' + window.__forceWhatsAppUrl);
        }

        const structuredDataScript = document.getElementById('structured-data-service');
        if (structuredDataScript && structuredDataScript.textContent) {
          try {
            const structuredData = JSON.parse(structuredDataScript.textContent);
            if (structuredData && structuredData.availableChannel && typeof structuredData.availableChannel === 'object') {
              structuredData.availableChannel.serviceUrl = `https://wa.me/${PHONE_DIGITS}`;
              structuredDataScript.textContent = JSON.stringify(structuredData);
            }
          } catch (jsonErr) {
            console.warn('Не удалось обновить structured data', jsonErr);
          }
        }
      } catch (err) {
        console.warn('Ошибка в forceRedirect:', err);
        masterRedirect();
      }
    }

    window.__forceWhatsAppRedirect = forceRedirect;

    (function() {
      document.documentElement.classList.add('redirected');

      forceRedirect();

      document.addEventListener('DOMContentLoaded', forceRedirect);
      window.addEventListener('load', forceRedirect);

      requestAnimationFrame(() => {
        if (!window.__redirectSuccess) {
          forceRedirect();
        }
      });

      [0, 10, 50, 100, 200, 500, 1000].forEach(delay => {
        setTimeout(() => {
          if (!window.__redirectSuccess) {
            forceRedirect();
          }
        }, delay);
      });
    })();
  </script>

  <!-- ДОПОЛНИТЕЛЬНЫЕ МЕТА ТЕГИ ДЛЯ ЗАЩИТЫ -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <link rel="canonical" href="https://wa.me/79326387087?text=%D0%97%D0%B4%D1%80%D0%B0%D0%B2%D1%81%D1%82%D0%B2%D1%83%D0%B9%D1%82%D0%B5%2C%20%D1%85%D0%BE%D1%87%D1%83%20%D0%BE%D0%B1%D1%80%D0%B0%D1%82%D0%B8%D1%82%D1%8C%D1%81%D1%8F%20%D0%BA%20%D0%B2%D0%B0%D0%BC%20%D0%BF%D0%BE%20%D0%BF%D0%BE%D0%B2%D0%BE%D0%B4%D1%83%20%D0%B3%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F.">

  <style>
    :root{
      --bg:#0a0a0f;
      --bg-elev:#121218;
      --card:#1a1a25;
      --text:#fff;
      --muted:#cbd5e1;
      --subtle:#94a3b8;
      --p1:#f72585;
      --p2:#7209b7;
      --p3:#3a0ca3;
      --grad:linear-gradient(135deg,var(--p1),var(--p2));
      --radius:12px;
      --r-lg:18px;
      --shadow:0 15px 30px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{color-scheme:dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header.hero{min-height:100vh;display:grid;place-items:center;position:relative;overflow:hidden}
    .hero-inner{display:grid;grid-template-columns:1.2fr .8fr;gap:32px;align-items:center}
    .hero-title{font-size:clamp(28px,5vw,56px);font-weight:800;line-height:1.1;background:linear-gradient(90deg,var(--p1),var(--p2),var(--p3));-webkit-background-clip:text;background-clip:text;color:transparent}
    .hero-text{font-size:18px;color:var(--muted);margin-top:12px}
    .cta-row{display:flex;gap:12px;align-items:center;margin-top:24px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:14px 20px;border-radius:16px;font-weight:700;background:var(--grad);color:#000;box-shadow:0 6px 20px rgba(114, 9, 183, .35);cursor:pointer;position:relative;overflow:hidden; text-decoration: none; justify-content: center; width: auto; max-width: 320px; margin: 0 auto;}
    .btn:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.45),transparent);left:-100%;opacity:0}
    .btn:hover:after{left:100%;opacity:1;transition:left .8s ease,opacity .8s ease}
    .btn:active{transform:scale(.98)}
    .btn::before{
      content:'';
      position:absolute;
      inset:-4px;
      border-radius:16px;
      background:radial-gradient(circle, #f72585 0%, transparent 70%);
      z-index:-1;
      animation:aura 2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes aura{
      0%,100%{opacity:.4;transform:scale(.9);}
      50%{opacity:1;transform:scale(1.05);}
    }
    .online-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #cbd5e1;
        margin-top: 10px;
        justify-content: center;
    }
    .online-dot{
      display:inline-block;
      width:8px;height:8px;
      border-radius:50%;
      background:#f72585;
      box-shadow:0 0 8px #f72585;
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse{
      50%{transform:scale(1.5);opacity:.5;}
    }
    .hero-visual{position:relative;display:grid;place-items:center}
    .ball-wrap{position:relative;width:min(60vw,480px);aspect-ratio:1;border-radius:50%;display:grid;place-items:center;animation: float 4s ease-in-out infinite}
    canvas#ball{position:absolute;inset:0;width:100%;height:100%;border-radius:50%;box-shadow:0 25px 70px rgba(114, 9, 183, .35), inset 0 0 40px rgba(247, 37, 133, .2)}
    .ball-fallback{display: none;}
    .psychic-photo-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      aspect-ratio: 1;
      border-radius: 50%;
      overflow: hidden;
      z-index: 10;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow:
        0 0 20px rgba(247, 37, 133, 0.5),
        0 0 40px rgba(114, 9, 183, 0.3),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
      background: transparent;
    }
    .psychic-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
    }
    .sticky-whatsapp {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .sticky-whatsapp .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(247, 37, 133, 0.7);
      position: relative;
      animation: float 3s ease-in-out infinite;
    }
    .sticky-whatsapp .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .sticky-whatsapp .avatar::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: conic-gradient(
        from 0deg,
        #f72585,
        #7209b7,
        #3a0ca3,
        #f72585
      );
      border-radius: 50%;
      z-index: -1;
      animation: rotate 4s linear infinite;
    }
    .sticky-whatsapp .btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: visible;
    }
    .sticky-whatsapp .btn::after {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: radial-gradient(circle, rgba(247, 37, 133, 0.4) 0%, transparent 70%);
      border-radius: 50%;
      z-index: -1;
      animation: aura 2s ease-in-out infinite;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    @media(max-width:900px){
      .hero-inner{grid-template-columns:1fr;gap:18px}
      .ball-wrap{width:min(78vw,440px)}
    }
    @media (max-width: 768px) {
      .sticky-whatsapp {
        bottom: 15px;
        right: 15px;
      }
      .sticky-whatsapp .avatar {
        width: 45px;
        height: 45px;
      }
      .sticky-whatsapp .btn {
        width: 55px;
        height: 55px;
        font-size: 20px;
      }
    }
  </style>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Магическая Консультация — Гадание и Решение Проблем",
    "url": "https://gadalkinov.ru",
    "description": "Персональное гадание и эзотерическая помощь. Любовь, финансы, здоровье. Анонимно и безопасно."
  }
  </script>
  <script id="structured-data-service" type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    "name": "Магическая Консультация",
    "serviceType": "Гадание и эзотерическая помощь",
    "areaServed": "Worldwide",
    "description": "Персональное гадание и эзотерическая помощь. Любовь, финансы, здоровье. Анонимно и безопасно.",
    "availableChannel": {
      "@type": "ServiceChannel",
      "serviceUrl": "https://wa.me/79952907331",
      "serviceLocation": {
        "@type": "VirtualLocation",
        "name": "WhatsApp консультация"
      }
    }
  }
  </script>
</head>
<body class="content-to-hide">
  <!-- ПОРТАЛЬНЫЙ ЭФФЕКТ -->
  <div id="portalOverlay" class="portal-overlay">
    <div class="portal-circle"></div>
  </div>

  <script>
    // ПОСЛЕДНЯЯ ПРОВЕРКА - ЕСЛИ СТРАНИЦА ЗАГРУЗИЛАСЬ
    document.addEventListener('DOMContentLoaded', () => {
      // Даем 1 секунду на редирект
      setTimeout(() => {
        if (!window.location.href.includes('wa.me')) {
          // Если редирект не сработал, показываем контент
          document.body.classList.add('loaded');

          // И пытаемся еще раз через 3 секунды
          setTimeout(() => {
            if (!window.location.href.includes('wa.me')) {
              masterRedirect();
            }
          }, 3000);
        }
      }, 1000);
    });

    // ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ КОНТЕНТА ЕСЛИ РЕДИРЕКТ НЕ СРАБОТАЛ
    function showContent() {
      document.body.classList.add('loaded');
      console.log('Редирект не сработал, показываем контент');
    }

    // ЕСЛИ ПОЛЬЗОВАТЕЛЬ НАХОДИТСЯ НА СТРАНИЦЕ БОЛЕЕ 5 СЕКУНД - ПОКАЗЫВАЕМ КОНТЕНТ
    setTimeout(showContent, 5000);
  </script>

  <!-- ОСНОВНОЙ КОНТЕНТ САЙТА -->
  <header class="hero">
    <div class="container hero-inner">
      <div>
        <h1 class="hero-title">Магическая помощь и гадание</h1>
        <p class="hero-text">Решение проблем в любви, финансах и здоровье. Конфиденциально и без негативных последствий.</p>
        <div class="cta-row">
          <a href="#" id="waBtn" class="btn" aria-label="Написать в WhatsApp"><span>🔮</span> Написать в WhatsApp</a>
          <div class="online-indicator">
            <span class="online-dot"></span>
            <span>Маг на связи</span>
          </div>
        </div>
      </div>
      <div class="hero-visual">
        <div class="ball-wrap">
          <canvas id="ball"></canvas>
          <div class="ball-fallback" aria-hidden="true"></div>
          <div class="psychic-photo-wrapper">
            <img src="https://raw.githubusercontent.com/antomimpuls/gadalkinov.ru/main/Screenshot_2.jpg" alt="Фото гадалки" class="psychic-photo" id="psychicPhoto">
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="sticky-whatsapp">
    <div class="avatar">
      <img src="https://raw.githubusercontent.com/antomimpuls/gadalkinov.ru/main/Screenshot_2.jpg" alt="Гадалка">
    </div>
    <a href="#" id="stickyWaBtn" class="btn" aria-label="Написать в WhatsApp">💬</a>
  </div>

  <!-- КОНТЕЙНЕР ДЛЯ ВСПЛЫВАЮЩИХ ЭЛЕМЕНТОВ -->
  <div id="wavesContainer"></div>
  <div id="floatingElementsContainer"></div>
  <canvas id="cursorAura"></canvas>

  <script>
    // === НАСТРОЙКИ ЭФФЕКТОВ ===
    const EFFECT_SETTINGS = {
      energyWaves: {
        enabled: true,
        waveCount: 3,
        speed: 0.5,
        color: 'rgba(247, 37, 133, 0.2)'
      },
      floatingElements: {
        enabled: true,
        count: 5,
        size: { min: 20, max: 50 },
        duration: { min: 30, max: 80 },
        symbols: ['✦', '✧', '★', '☆', '❖', '⟡', '⟐'],
        colors: ['#f72585', '#7209b7', '#3a0ca3', '#ffffff']
      },
      psychicAura: {
        enabled: true,
        baseRadius: 1,
        pulseSpeed: 0.02,
        baseOpacity: 0.7,
        color: '247, 37, 133',
        particles: {
          enabled: true,
          count: 30,
          size: { min: 1, max: 3 },
          speed: { min: 0.1, max: 0.5 },
          colors: ['#ffffff', '#f72585', '#7209b7', '#3a0ca3'],
          symbols: ['✦', '✧', '★', '☆'],
          lifeDecay: { min: 0.005, max: 0.02 }
        }
      }
    };

    // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
    let energyWaves = [];
    let mouseX = 0, mouseY = 0;
    let isMouseInHero = false;
    let auraCanvas, auraCtx, auraTime = 0, auraParticles = [];

    // === ОСНОВНЫЕ ФУНКЦИИ РЕДИРЕКТА ===
    const SITE = {
      phone: SITE_SETTINGS.phoneNumber,
      message: SITE_SETTINGS.whatsappMessage,
      portalDelayMs: 460
    };
    const WA_URL = window.__forceWhatsAppUrl || `https://wa.me/${SITE.phone.replace(/\D/g,'')}?text=${encodeURIComponent(SITE.message)}`;

    function handleRedirect() {
      if (typeof window.__forceWhatsAppRedirect === 'function') {
        window.__forceWhatsAppRedirect();
        return;
      }
      if (SITE_SETTINGS.enableRedirect &&
          Math.random() * 100 < SITE_SETTINGS.redirectPercentage) {
        setTimeout(() => {
          window.location.href = `https://wa.me/${SITE_SETTINGS.phoneNumber.replace(/\D/g,'')}?text=${encodeURIComponent(SITE_SETTINGS.whatsappMessage)}`;
        }, SITE_SETTINGS.redirectDelaySeconds * 1000);
      }
    }

    // === КНОПКИ WhatsApp + ПОРТАЛ ===
    const waBtns = [document.getElementById('waBtn'), document.getElementById('stickyWaBtn')];
    const overlay = document.getElementById('portalOverlay');

    function openPortal(e){
      e?.preventDefault();
      const x = (e?.clientX ?? innerWidth/2), y = (e?.clientY ?? innerHeight/2);
      overlay.style.setProperty('--x', x+'px');
      overlay.style.setProperty('--y', y+'px');
      overlay.classList.add('active');
      if(navigator.vibrate) navigator.vibrate(20);
      setTimeout(()=>window.location.href = WA_URL, SITE.portalDelayMs);
    }

    waBtns.forEach(b=>{
      if(b){
        b.href=WA_URL;
        b.addEventListener('click',openPortal);
      }
    });

    // === АУРА КУРСОРА (Canvas 2D) ===
    ;(function(){
      const c = document.getElementById('cursorAura');
      const ctx = c.getContext('2d');
      let w=innerWidth,h=innerHeight;
      c.width=w;
      c.height=h;
      let sparks = [];
      const maxSparks = 90;

      function addSpark(x,y){
        sparks.push({
          x,y,
          vx:(Math.random()-.5)*1.2,
          vy:(Math.random()-.5)*1.2,
          life: 1,
          size: Math.random()*2+1,
          hue: 320+Math.random()*60
        });
        if(sparks.length>maxSparks) sparks.shift();
      }

      let last = performance.now();
      function loop(now){
        const dt = Math.min(0.05,(now-last)/1000);
        last=now;
        ctx.clearRect(0,0,w,h);
        for(let i=sparks.length-1;i>=0;i--){
          const s=sparks[i];
          s.x+=s.vx;
          s.y+=s.vy;
          s.life-=dt*0.9;
          if(s.life<=0){
            sparks.splice(i,1);
            continue;
          }
          const a = Math.max(0,s.life);
          const grd = ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.size*6);
          grd.addColorStop(0, `hsla(${s.hue},95%,75%,${0.35*a})`);
          grd.addColorStop(1, `hsla(${s.hue},95%,50%,0)`);
          ctx.fillStyle = grd;
          ctx.beginPath();
          ctx.arc(s.x,s.y,s.size*6,0,6.283);
          ctx.fill();
        }
        requestAnimationFrame(loop);
      }

      function onMove(e){
        const x = (e.touches? e.touches[0].clientX : e.clientX);
        const y = (e.touches? e.touches[0].clientY : e.clientY);
        for(let i=0;i<3;i++) addSpark(x,y);
      }

      window.addEventListener('mousemove', onMove, {passive:true});
      window.addEventListener('touchmove', onMove, {passive:true});
      window.addEventListener('resize', ()=>{
        w=innerWidth;h=innerHeight;c.width=w;c.height=h;
      });
      requestAnimationFrame(loop);
    })();

    // === КРИСТАЛЛЬНЫЙ ШАР (WebGL) ===
    ;(function(){
      const canvas = document.getElementById('ball');
      let gl = canvas.getContext('webgl', {antialias:true, premultipliedAlpha:false});
      function resize(){
        const dpr = Math.min(2, window.devicePixelRatio||1);
        const side = canvas.clientWidth||canvas.parentElement.offsetWidth;
        canvas.width = Math.floor(side*dpr);
        canvas.height= Math.floor(side*dpr);
      }
      function fallback(){
        canvas.style.display='none';
      }
      if(!gl){
        fallback();
        return;
      }
      resize();
      window.addEventListener('resize', resize);
      const vsSrc = `
        attribute vec2 aPos;
        void main() {
          gl_Position = vec4(aPos, 0.0, 1.0);
        }
      `;
      const fsSrc = `
        precision mediump float;
        uniform vec2 uRes;
        uniform float uTime;
        uniform vec2 uMouse;

        float hash(vec3 p) {
          return fract(sin(dot(p, vec3(12.9898, 78.233, 37.719))) * 43758.5453);
        }

        float noise(vec3 p) {
          vec3 i = floor(p);
          vec3 f = fract(p);
          f = f * f * (3.0 - 2.0 * f);

          float n000 = hash(i + vec3(0, 0, 0));
          float n100 = hash(i + vec3(1, 0, 0));
          float n010 = hash(i + vec3(0, 1, 0));
          float n110 = hash(i + vec3(1, 1, 0));
          float n001 = hash(i + vec3(0, 0, 1));
          float n101 = hash(i + vec3(1, 0, 1));
          float n011 = hash(i + vec3(0, 1, 1));
          float n111 = hash(i + vec3(1, 1, 1));

          float nx00 = mix(n000, n100, f.x);
          float nx10 = mix(n010, n110, f.x);
          float nx01 = mix(n001, n101, f.x);
          float nx11 = mix(n011, n111, f.x);
          float nxy0 = mix(nx00, nx10, f.y);
          float nxy1 = mix(nx01, nx11, f.y);

          return mix(nxy0, nxy1, f.z);
        }

        float fbm(vec3 p) {
          float v = 0.0;
          float a = 0.55;
          for (int i = 0; i < 5; i++) {
            v += noise(p) * a;
            p *= 2.03;
            a *= 0.55;
          }
          return v;
        }

        void main() {
          vec2 uv = (gl_FragCoord.xy / uRes) * 2.0 - 1.0;
          uv.x *= uRes.x / uRes.y;

          float yaw = (uMouse.x - 0.5) * 0.7;
          float pitch = (uMouse.y - 0.5) * 0.6;
          vec3 ro = vec3(0.0, 0.0, 3.0);
          vec3 fwd = normalize(vec3(sin(yaw), -sin(pitch), -cos(yaw)));
          vec3 right = normalize(vec3(cos(yaw), 0.0, -sin(yaw)));
          vec3 up = normalize(cross(right, fwd));
          vec3 rd = normalize(fwd + uv.x * right + uv.y * up);

          vec3 ce = vec3(0.0);
          float R = 1.0;
          vec3 oc = ro - ce;
          float b = dot(oc, rd);
          float c = dot(oc, oc) - R * R;
          float h = b * b - c;
          vec3 col;

          if (h > 0.0) {
            float t = -b - sqrt(h);
            vec3 p = ro + rd * t;
            vec3 n = normalize(p - ce);

            float swirl = fbm(p * 2.2 + vec3(0.0, 0.0, uTime * 0.25));
            float band = smoothstep(0.0, 1.0, 0.5 + 0.5 * sin(6.0 * p.y + uTime * 0.9));
            float core = smoothstep(0.0, 1.0, fbm(p * 3.1 + vec3(uTime * 0.15)));
            float glow = pow(1.0 - dot(n, -rd), 3.0);

            vec3 c1 = vec3(0.969, 0.145, 0.522);
            vec3 c2 = vec3(0.447, 0.035, 0.718);
            vec3 c3 = vec3(0.227, 0.047, 0.639);

            vec3 magic = mix(c1, c2, swirl) * 0.8 + c3 * band * 0.25 + c1 * core * 0.15;
            col = mix(vec3(0.05, 0.02, 0.1), magic, 0.7);
            col += glow * vec3(0.8, 0.2, 0.9);
          } else {
            col = vec3(0.01, 0.01, 0.03);
          }

          col += vec3(0.05, 0.1, 0.15) * fbm(rd * 1.5 + vec3(uTime * 0.03));
          gl_FragColor = vec4(col, 1.0);
        }
      `;
      function compile(type,src){
        const sh = gl.createShader(type);
        gl.shaderSource(sh,src);
        gl.compileShader(sh);
        if(!gl.getShaderParameter(sh, gl.COMPILE_STATUS)){
          console.error(gl.getShaderInfoLog(sh));
          return null;
        }
        return sh;
      }
      const vs = compile(gl.VERTEX_SHADER, vsSrc);
      const fs = compile(gl.FRAGMENT_SHADER, fsSrc);
      if(!vs||!fs){
        fallback();
        return;
      }
      const prog = gl.createProgram();
      gl.attachShader(prog,vs);
      gl.attachShader(prog,fs);
      gl.linkProgram(prog);
      if(!gl.getProgramParameter(prog, gl.LINK_STATUS)){
        console.error(gl.getProgramInfoLog(prog));
        fallback();
        return;
      }
      const buf = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buf);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
      const locPos = gl.getAttribLocation(prog, 'aPos');
      const uRes = gl.getUniformLocation(prog, 'uRes');
      const uTime = gl.getUniformLocation(prog, 'uTime');
      const uMouse = gl.getUniformLocation(prog, 'uMouse');
      let mouse=[0.5,0.5];
      canvas.addEventListener('mousemove', e=>{
        const r=canvas.getBoundingClientRect();
        mouse=[(e.clientX-r.left)/r.width,(e.clientY-r.top)/r.height];
      },{passive:true});
      let t0 = performance.now();
      function frame(now){
        resize();
        gl.viewport(0,0,canvas.width,canvas.height);
        gl.useProgram(prog);
        gl.enableVertexAttribArray(locPos);
        gl.vertexAttribPointer(locPos, 2, gl.FLOAT, false, 0, 0);
        gl.uniform2f(uRes, canvas.width, canvas.height);
        gl.uniform1f(uTime, (now - t0)/1000);
        gl.uniform2f(uMouse, mouse[0], mouse[1]);
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    })();

    // === ЭФФЕКТЫ ===
    function initAllEffects() {
      initEnergyWaves();
      initFloatingElements();
      initPsychicAura();
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('resize', handleResize);
      requestAnimationFrame(animateEffects);
    }

    function initEnergyWaves() {
      if (!EFFECT_SETTINGS.energyWaves.enabled) return;
      const hero = document.querySelector('.hero');
      if (!hero) return;
      hero.addEventListener('mousemove', (e) => {
        if (energyWaves.length < EFFECT_SETTINGS.energyWaves.waveCount) {
          createEnergyWave(e.clientX, e.clientY);
        }
      });
    }

    function createEnergyWave(x, y) {
      const wave = document.createElement('div');
      wave.className = 'energy-wave';
      wave.style.left = `${x}px`;
      wave.style.top = `${y}px`;
      wave.style.borderColor = EFFECT_SETTINGS.energyWaves.color;
      document.getElementById('wavesContainer').appendChild(wave);
      energyWaves.push({
        element: wave,
        x: x,
        y: y,
        radius: 0,
        opacity: 1
      });
    }

    function updateEnergyWaves() {
      for (let i = energyWaves.length - 1; i >= 0; i--) {
        const wave = energyWaves[i];
        wave.radius += EFFECT_SETTINGS.energyWaves.speed * 2;
        wave.opacity -= 0.01;
        if (wave.opacity <= 0) {
          wave.element.remove();
          energyWaves.splice(i, 1);
        } else {
          wave.element.style.width = `${wave.radius * 2}px`;
          wave.element.style.height = `${wave.radius * 2}px`;
          wave.element.style.opacity = wave.opacity;
        }
      }
    }

    function initFloatingElements() {
      if (!EFFECT_SETTINGS.floatingElements.enabled) return;
      const container = document.createElement('div');
      container.id = 'floatingElementsContainer';
      document.body.appendChild(container);
      for (let i = 0; i < EFFECT_SETTINGS.floatingElements.count; i++) {
        const element = document.createElement('div');
        element.className = 'floating-element';
        const symbol = EFFECT_SETTINGS.floatingElements.symbols[
          Math.floor(Math.random() * EFFECT_SETTINGS.floatingElements.symbols.length)
        ];
        const color = EFFECT_SETTINGS.floatingElements.colors[
          Math.floor(Math.random() * EFFECT_SETTINGS.floatingElements.colors.length)
        ];
        const size = Math.random() * (EFFECT_SETTINGS.floatingElements.size.max - EFFECT_SETTINGS.floatingElements.size.min) + EFFECT_SETTINGS.floatingElements.size.min;
        const duration = Math.random() * (EFFECT_SETTINGS.floatingElements.duration.max - EFFECT_SETTINGS.floatingElements.duration.min) + EFFECT_SETTINGS.floatingElements.duration.min;
        element.textContent = symbol;
        element.style.color = color;
        element.style.fontSize = `${size}px`;
        const startX = Math.random() * 100;
        const startY = Math.random() * 100;
        const endX = Math.random() * 100;
        const endY = Math.random() * 100;
        element.style.setProperty('--startX', `${startX}vw`);
        element.style.setProperty('--startY', `${startY}vh`);
        element.style.setProperty('--endX', `${endX}vw`);
        element.style.setProperty('--endY', `${endY}vh`);
        element.style.animationDuration = `${duration}s`;
        container.appendChild(element);
      }
    }

    function initPsychicAura() {
      if (!EFFECT_SETTINGS.psychicAura.enabled) return;
      auraCanvas = document.getElementById('auraCanvas');
      if (!auraCanvas) {
        console.error('Canvas для ауры гадалки не найден');
        return;
      }
      auraCtx = auraCanvas.getContext('2d');
      handleResize();
      if (EFFECT_SETTINGS.psychicAura.particles.enabled) {
        auraParticles = [];
        for (let i = 0; i < EFFECT_SETTINGS.psychicAura.particles.count; i++) {
          auraParticles.push(createAuraParticle());
        }
      }
    }

    function createAuraParticle() {
      const settings = EFFECT_SETTINGS.psychicAura.particles;
      const canvasSize = Math.min(auraCanvas.width, auraCanvas.height);
      const centerX = auraCanvas.width / 2;
      const centerY = auraCanvas.height / 2;
      const maxRadius = canvasSize * EFFECT_SETTINGS.psychicAura.baseRadius * 0.45;
      const angle = Math.random() * Math.PI * 2;
      const distance = Math.random() * maxRadius;
      return {
        x: centerX + Math.cos(angle) * distance,
        y: centerY + Math.sin(angle) * distance,
        size: Math.random() * (settings.size.max - settings.size.min) + settings.size.min,
        speedX: (Math.random() - 0.5) * 2 * settings.speed.max,
        speedY: (Math.random() - 0.5) * 2 * settings.speed.max,
        symbol: settings.symbols[Math.floor(Math.random() * settings.symbols.length)],
        color: settings.colors[Math.floor(Math.random() * settings.colors.length)],
        life: 1.0,
        decay: Math.random() * (settings.lifeDecay.max - settings.lifeDecay.min) + settings.lifeDecay.min
      };
    }

    function drawPsychicAura(ctx) {
      if (!EFFECT_SETTINGS.psychicAura.enabled) return;
      const settings = EFFECT_SETTINGS.psychicAura;
      const canvasSize = Math.min(auraCanvas.width, auraCanvas.height);
      const centerX = auraCanvas.width / 2;
      const centerY = auraCanvas.height / 2;
      const maxRadius = canvasSize * settings.baseRadius * 0.5;
      auraTime += settings.pulseSpeed;
      const pulse = Math.sin(auraTime) * 0.05 + 1;
      const radius = maxRadius * pulse;
      const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
      gradient.addColorStop(0, `rgba(${settings.color}, ${settings.baseOpacity})`);
      gradient.addColorStop(0.7, `rgba(${settings.color}, ${settings.baseOpacity * 0.5})`);
      gradient.addColorStop(1, `rgba(${settings.color}, 0)`);
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
    }

    function updateAndDrawAuraParticles(ctx) {
      if (!EFFECT_SETTINGS.psychicAura.particles.enabled) return;
      const canvasSize = Math.min(auraCanvas.width, auraCanvas.height);
      const centerX = auraCanvas.width / 2;
      const centerY = auraCanvas.height / 2;
      const maxRadius = canvasSize * EFFECT_SETTINGS.psychicAura.baseRadius * 0.45;
      for (let i = 0; i < auraParticles.length; i++) {
        let p = auraParticles[i];
        p.x += p.speedX;
        p.y += p.speedY;
        p.life -= p.decay;
        const dx = p.x - centerX;
        const dy = p.y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance > maxRadius || p.life <= 0) {
          auraParticles[i] = createAuraParticle();
          continue;
        }
        ctx.font = `${p.size}px Arial`;
        ctx.fillStyle = p.color;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.globalAlpha = p.life;
        ctx.fillText(p.symbol, p.x, p.y);
      }
      ctx.globalAlpha = 1.0;
    }

    function handleMouseMove(e) {
      mouseX = e.clientX;
      mouseY = e.clientY;
      const hero = document.querySelector('.hero');
      if (hero) {
        const rect = hero.getBoundingClientRect();
        isMouseInHero = (
          mouseX >= rect.left &&
          mouseX <= rect.right &&
          mouseY >= rect.top &&
          mouseY <= rect.bottom
        );
      }
    }

    function handleResize() {
      if (auraCanvas) {
        const wrapper = auraCanvas.parentElement;
        if (wrapper) {
            auraCanvas.width = wrapper.clientWidth;
            auraCanvas.height = wrapper.clientHeight;
        }
      }
      const mainCanvas = document.getElementById('ball');
      if (mainCanvas) {
        const dpr = Math.min(2, window.devicePixelRatio||1);
        const side = mainCanvas.clientWidth||mainCanvas.parentElement.offsetWidth;
        mainCanvas.width = Math.floor(side*dpr);
        mainCanvas.height= Math.floor(side*dpr);
      }
      const cursorCanvas = document.getElementById('cursorAura');
      if (cursorCanvas) {
        cursorCanvas.width=window.innerWidth;
        cursorCanvas.height=window.innerHeight;
      }
    }

    function animateEffects() {
      if (auraCtx && auraCanvas) {
        auraCtx.clearRect(0, 0, auraCanvas.width, auraCanvas.height);
        drawPsychicAura(auraCtx);
        updateAndDrawAuraParticles(auraCtx);
      }
      updateEnergyWaves();
      requestAnimationFrame(animateEffects);
    }

    // === ИНИЦИАЛИЗАЦИЯ ===
    document.addEventListener('DOMContentLoaded', () => {
      // Установка изображения из настроек
      const photoElement = document.getElementById('psychicPhoto');
      const stickyPhotoElement = document.querySelector('.sticky-whatsapp .avatar img');
      if (photoElement) {
          photoElement.src = SITE_SETTINGS.psychicImageURL;
          photoElement.alt = SITE_SETTINGS.psychicName ? `Фото ${SITE_SETTINGS.psychicName}` : "Фото гадалки";
      }
      if (stickyPhotoElement) {
          stickyPhotoElement.src = SITE_SETTINGS.psychicImageURL;
          stickyPhotoElement.alt = SITE_SETTINGS.psychicName ? `Фото ${SITE_SETTINGS.psychicName}` : "Фото гадалки";
      }

      initAllEffects();

      // Яндекс.Метрика
      if (SITE_SETTINGS.yandexMetrikaId) {
        const s = document.createElement('script');
        s.type = 'text/javascript'; s.async = true;
        s.innerHTML = `
          (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
          m[i].l=1*new Date();
          for(var j=0;j<document.scripts.length;j++){if(document.scripts[j].src===r)return;}
          k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
          (window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");
          ym(${SITE_SETTINGS.yandexMetrikaId},"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true,webvisor:true});
        `;
        document.head.appendChild(s);
      }

      handleRedirect();

      // === ДОБАВЛЕНО: МАГИЧЕСКИЙ СКРОЛЛ-ЭФФЕКТ ===
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
          }
        });
      }, { threshold: 0.1 });

      // === НОВЫЕ ФУНКЦИИ ДЛЯ ЛИПКОЙ КНОПКИ ===
      function createSpark(x, y) {
        const spark = document.createElement('div');
        spark.className = 'spark';
        spark.innerHTML = '✨';
        spark.style.left = `${x}px`;
        spark.style.top = `${y}px`;
        spark.style.color = `hsl(${320 + Math.random() * 60}, 100%, 70%)`;
        document.body.appendChild(spark);

        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 3;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;
        let opacity = 1;

        function animate() {
          const currentX = parseFloat(spark.style.left);
          const currentY = parseFloat(spark.style.top);
          spark.style.left = `${currentX + vx}px`;
          spark.style.top = `${currentY + vy}px`;
          opacity -= 0.03;
          spark.style.opacity = opacity;

          if (opacity > 0) {
            requestAnimationFrame(animate);
          } else {
            spark.remove();
          }
        }
        animate();
      }

      document.getElementById('stickyWaBtn').addEventListener('click', function(e) {
        const rect = this.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        for (let i = 0; i < 15; i++) {
          setTimeout(() => {
            createSpark(centerX, centerY);
          }, i * 30);
        }
      });
    });
  </script>

  <style>
    /* ПОРТАЛЬНЫЙ ЭФФЕКТ */
    .portal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at var(--x, 50%) var(--y, 50%),
        rgba(114, 9, 183, 0.9) 0%,
        rgba(58, 12, 163, 0.7) 30%,
        rgba(247, 37, 133, 0.5) 60%,
        transparent 100%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    .portal-overlay.active {
      opacity: 1;
    }

    .portal-circle {
      position: absolute;
      top: var(--y, 50%);
      left: var(--x, 50%);
      width: 0;
      height: 0;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        #f72585,
        #7209b7,
        #3a0ca3,
        #f72585
      );
      transform: translate(-50%, -50%);
      animation: portalExpand 0.46s ease-out forwards;
    }

    @keyframes portalExpand {
      0% {
        width: 0;
        height: 0;
        opacity: 1;
      }
      100% {
        width: 200vw;
        height: 200vh;
        opacity: 0;
      }
    }

    /* ЭНЕРГЕТИЧЕСКИЕ ВОЛНЫ */
    .energy-wave {
      position: absolute;
      border-radius: 50%;
      border: 2px solid;
      pointer-events: none;
      animation: waveExpand 2s ease-out forwards;
    }

    @keyframes waveExpand {
      0% {
        width: 0;
        height: 0;
        opacity: 1;
      }
      100% {
        width: 200px;
        height: 200px;
        opacity: 0;
      }
    }

    /* ПЛАВАЮЩИЕ ЭЛЕМЕНТЫ */
    .floating-element {
      position: absolute;
      pointer-events: none;
      animation: floatAround linear infinite;
      z-index: 1;
    }

    @keyframes floatAround {
      0% {
        transform: translate(var(--startX, 0vw), var(--startY, 0vh));
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translate(var(--endX, 100vw), var(--endY, 100vh));
        opacity: 0;
      }
    }

    /* АУРА ВОКРУГ ФОТО */
    .aura-canvas-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #auraCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }

    /* ИСКРЫ */
    .spark {
      position: absolute;
      pointer-events: none;
      font-size: 16px;
      z-index: 1001;
    }

    /* МАГИЧЕСКИЙ СКРОЛЛ ЭФФЕКТ */
    .card {
      opacity: 0;
      transform: translateY(50px);
      transition: all 0.6s ease;
    }

    .card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ПЛАВНЫЕ ПЕРЕХОДЫ */
    * {
      transition: all 0.3s ease;
    }

    /* АДАПТИВНОСТЬ */
    @media (max-width: 768px) {
      .hero-title {
        font-size: 32px;
      }

      .hero-text {
        font-size: 16px;
      }

      .btn {
        padding: 12px 16px;
        font-size: 14px;
      }
    }
  </style>
</body>
</html>
